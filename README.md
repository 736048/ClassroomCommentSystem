# CCS (Classroom Comment System)

授業、セミナー、プレゼンテーションにおいて、参加者のリアルタイムな反応を投影画面へ統合するためのデスクトップ・オーバーレイ・アプリケーションです。Electronフレームワークを基盤とし、双方向通信と高度なウィンドウ制御を組み合わせることで、既存のプレゼンテーション資料を妨げることなく動的なコミュニケーション空間を構築します。

---

## 主要機能の詳細

### 1. 高度なコメント投影システム
*   蛍（ホタル）表示アルゴリズム：コメントをスクロールさせず、画面上のランダムな座標にフェードイン・滞在・フェードアウトさせる独自のアニメーションを実装しています。これにより、視聴者の視線移動を最小限に抑えつつ、複数のコメントを同時に提示することが可能です。
*   可読性の自動最適化：送信されたカラーデータに基づき、明度の低い文字には白の縁取り、明度の高い文字には黒の縁取りをCSSのtext-shadowスタックを用いて適用します。
*   マルチディスプレイ・ターゲティング：外部モニター接続を検知し、OSのデスクトップ領域外への描画（enableLargerThanScreen）と最前面表示（alwaysOnTop: 'screen-saver'）を組み合わせることで、PowerPoint等の全画面スライドショーの上にも確実にコメントを重畳させます。

### 2. インタラクティブな先生用管理パネル
*   物理比率同期キャンバス：デスクトップ領域の解像度比率（16:9等）を自動取得し、管理画面内の編集パレットにアスペクト比を固定して適用します。これにより、パレット上の操作位置と実際の投影位置のピクセル等価性を保証します。
*   PowerPoint風オブジェクト操作：
    *   図形描画：丸、四角、直線の各プリミティブをキャンバスに追加可能です。
    *   リアルタイム・トランスフォーム：配置した図形や「固定コメント」は、マウスドラッグによる移動、および右下のハンドル操作による自由なリサイズが可能です。
    *   複数オブジェクト管理：各オブジェクトにユニークIDを割り当て、個別の更新および削除（Delete/Backspaceキー）に対応しています。
*   プレゼンテーション・アシスタント：
    *   PPTノート同期：macOSのAppleScript（osascript）インターフェースを介して、Microsoft PowerPointのオブジェクトモデルから現在のスライド番号と発表者ノートを1秒間隔でポーリング取得します。
    *   経過時間計測：発表の進行を管理するための高精度なタイマー機能を搭載しています。

### 3. ネットワークおよび運用機能
*   動的サーバー再構築：動作中にポート番号を変更する際、既存のHTTP/Socketサーバーをクローズし、全接続クライアントへ通知（force_disconnect）を送った上で、即座に新しいポートで再起動します。
*   巨大QRコード・ブロードキャスト：Socket.ioによるブロードキャスト通信を利用し、先生の操作一つで管理画面と全参加者が見る投影画面の両方に、高解像度のQRコードをポップアップ表示します。
*   永続的NGワード・エンジン：JSONベースのNGワードリストを読み込み、送信された全てのコメントをサーバーサイドでバリデーションします。

---

## 技術スタックとアーキテクチャ

### 開発基盤
*   Runtime: Node.js
*   Framework: Electron 40.x
*   Server: Express 5.x
*   Real-time Engine: Socket.io 4.x

### フロントエンド技術
*   レスポンシブ・スケーリング：CSS Custom Propertiesとclamp()関数を用いた計算式により、解像度に応じてフォントサイズやUI要素を自動調整します。
*   座標系：管理画面と投影画面の間の座標同期には、デバイス非依存のパーセンテージベース座標系（0-100%）を採用しています。
*   アニメーション：Web Animations APIを使用し、メインスレッドをブロックしない滑らかなフェード効果を実現しています。

### バックエンドおよびシステム連携
*   AppleScript Bridge：child_processモジュールを使用してosascriptを実行。Microsoft PowerPointとのプロセス間通信を実現しています。
*   ネットワーク解析：os.networkInterfaces()を使用してローカルネットワーク上のIPv4アドレスを動的に特定し、接続用URLおよびQRコードを生成します。

---

## セットアップと使用方法

### システム要件
*   OS: macOS（PowerPoint同期機能を使用する場合。その他の機能はWindows/Linuxでも動作可）
*   Node.js: LTSバージョンを推奨

### インストール手順
1. プロジェクトルートで依存パッケージをインストール：
   ```bash
   npm install
   ```

### 実行方法
1. アプリケーションの起動：
   ```bash
   npm start
   ```

### 運用の流れ
1. 投影画面のセットアップ：外部モニターを接続し、透過ウィンドウが正しく配置されていることを確認します。
2. 接続の共有：管理画面の「QRコード表示」をクリックし、参加者にURLを共有します。
3. プレゼンテーションの開始：PowerPointのスライドショーを開始し、必要に応じて「同期ON」を切り替えます。

---

## ファイル構成
*   main.js: Electronのエントリーポイント。ウィンドウライフサイクル、IPC通信、サーバー制御を担当。
*   server/app.js: ExpressおよびSocket.ioのロジック。
*   renderer/control.html / .js: 先生用インターフェースのUI定義および操作ロジック。
*   renderer/overlay.html / .js / .css: 投影画面の描画およびアニメーション制御。
*   public/: 参加者（生徒）用Webクライアントのソースコード。

---

## ライセンス
ISC
